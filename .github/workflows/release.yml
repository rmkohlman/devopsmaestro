name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # Build nvp (no CGO) via GoReleaser on ubuntu
  # This handles all platforms since nvp doesn't need CGO
  goreleaser-nvp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}

  # Build dvm and dvt (both require CGO for SQLite) natively on macOS
  build-cgo-binaries-darwin:
    needs: [goreleaser-nvp]
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: macos-14        # Apple Silicon (M1/M2)
            goos: darwin
            goarch: arm64
          - runner: macos-15        # Intel
            goos: darwin
            goarch: amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build dvm and dvt
        env:
          CGO_ENABLED: 1
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          # Build dvm (DevOpsMaestro)
          go build -ldflags "-s -w -X main.Version=${{ steps.version.outputs.VERSION }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.Commit=$(git rev-parse --short HEAD)" -o dvm .
          
          # Build dvt (TerminalOps) 
          go build -ldflags "-s -w -X main.Version=${{ steps.version.outputs.VERSION }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.Commit=$(git rev-parse --short HEAD)" -o dvt ./cmd/dvt/

      - name: Generate completions
        run: |
          mkdir -p completions
          # DVM completions
          ./dvm completion bash > completions/dvm.bash
          ./dvm completion zsh > completions/_dvm
          ./dvm completion fish > completions/dvm.fish
          # DVT completions
          ./dvt completion bash > completions/dvt.bash
          ./dvt completion zsh > completions/_dvt
          ./dvt completion fish > completions/dvt.fish

      - name: Create archives
        run: |
          # Create dvm (DevOpsMaestro) archive
          tar -czvf devopsmaestro_${{ steps.version.outputs.VERSION }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz \
            dvm \
            completions/dvm.* \
            README.md \
            LICENSE
          
          # Create dvt (TerminalOps) archive
          tar -czvf terminalops_${{ steps.version.outputs.VERSION }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz \
            dvt \
            completions/dvt.* \
            README.md \
            LICENSE

      - name: Generate checksums
        run: |
          # Generate checksums for both archives
          shasum -a 256 devopsmaestro_${{ steps.version.outputs.VERSION }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz > devopsmaestro_${{ steps.version.outputs.VERSION }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz.sha256
          shasum -a 256 terminalops_${{ steps.version.outputs.VERSION }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz > terminalops_${{ steps.version.outputs.VERSION }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz.sha256

      - name: Wait for release to be ready
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Wait for release to be fully available via GitHub API
          for i in {1..30}; do
            if gh release view ${{ github.ref_name }} > /dev/null 2>&1; then
              echo "Release ${{ github.ref_name }} is ready"
              break
            fi
            echo "Waiting for release to be available... (attempt $i/30)"
            sleep 2
          done

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Upload both dvm and dvt archives with checksums
          gh release upload ${{ github.ref_name }} \
            devopsmaestro_${{ steps.version.outputs.VERSION }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz \
            devopsmaestro_${{ steps.version.outputs.VERSION }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz.sha256 \
            terminalops_${{ steps.version.outputs.VERSION }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz \
            terminalops_${{ steps.version.outputs.VERSION }}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz.sha256 \
            --clobber

  # Update Homebrew tap after all builds complete
  update-homebrew:
    needs: [goreleaser-nvp, build-cgo-binaries-darwin]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: rmkohlman/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Wait for release assets to be available
        run: sleep 30

      - name: Download release assets and compute checksums
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          
          # Download dvm archives
          gh release download v${VERSION} \
            --repo rmkohlman/devopsmaestro \
            --pattern "devopsmaestro_${VERSION}_darwin_*.tar.gz" \
            --dir /tmp/assets || true
          
          # Download dvt archives
          gh release download v${VERSION} \
            --repo rmkohlman/devopsmaestro \
            --pattern "terminalops_${VERSION}_darwin_*.tar.gz" \
            --dir /tmp/assets || true
          
          # Download nvp archives
          gh release download v${VERSION} \
            --repo rmkohlman/devopsmaestro \
            --pattern "nvp_${VERSION}_*.tar.gz" \
            --dir /tmp/assets || true
          
          # Compute checksums
          cd /tmp/assets
          for f in *.tar.gz; do
            shasum -a 256 "$f" | awk '{print $1}' > "${f}.sha256sum"
          done
          
          # Export checksums as env vars
          echo "DVM_DARWIN_ARM64_SHA256=$(cat devopsmaestro_${VERSION}_darwin_arm64.tar.gz.sha256sum 2>/dev/null || echo '')" >> $GITHUB_ENV
          echo "DVM_DARWIN_AMD64_SHA256=$(cat devopsmaestro_${VERSION}_darwin_amd64.tar.gz.sha256sum 2>/dev/null || echo '')" >> $GITHUB_ENV
          echo "DVT_DARWIN_ARM64_SHA256=$(cat terminalops_${VERSION}_darwin_arm64.tar.gz.sha256sum 2>/dev/null || echo '')" >> $GITHUB_ENV
          echo "DVT_DARWIN_AMD64_SHA256=$(cat terminalops_${VERSION}_darwin_amd64.tar.gz.sha256sum 2>/dev/null || echo '')" >> $GITHUB_ENV
          echo "NVP_DARWIN_ARM64_SHA256=$(cat nvp_${VERSION}_darwin_arm64.tar.gz.sha256sum 2>/dev/null || echo '')" >> $GITHUB_ENV
          echo "NVP_DARWIN_AMD64_SHA256=$(cat nvp_${VERSION}_darwin_amd64.tar.gz.sha256sum 2>/dev/null || echo '')" >> $GITHUB_ENV
          echo "NVP_LINUX_ARM64_SHA256=$(cat nvp_${VERSION}_linux_arm64.tar.gz.sha256sum 2>/dev/null || echo '')" >> $GITHUB_ENV
          echo "NVP_LINUX_AMD64_SHA256=$(cat nvp_${VERSION}_linux_amd64.tar.gz.sha256sum 2>/dev/null || echo '')" >> $GITHUB_ENV

      - name: Update devopsmaestro formula
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          cat > homebrew-tap/Formula/devopsmaestro.rb << 'FORMULA_EOF'
          # typed: false
          # frozen_string_literal: true

          class Devopsmaestro < Formula
            desc "DevOpsMaestro (dvm) - kubectl-style CLI for containerized dev environments"
            homepage "https://github.com/rmkohlman/devopsmaestro"
            version "VERSION_PLACEHOLDER"
            license "GPL-3.0"

            on_macos do
              on_arm do
                url "https://github.com/rmkohlman/devopsmaestro/releases/download/vVERSION_PLACEHOLDER/devopsmaestro_VERSION_PLACEHOLDER_darwin_arm64.tar.gz"
                sha256 "DVM_DARWIN_ARM64_SHA256_PLACEHOLDER"
              end
              on_intel do
                url "https://github.com/rmkohlman/devopsmaestro/releases/download/vVERSION_PLACEHOLDER/devopsmaestro_VERSION_PLACEHOLDER_darwin_amd64.tar.gz"
                sha256 "DVM_DARWIN_AMD64_SHA256_PLACEHOLDER"
              end
            end

            head "https://github.com/rmkohlman/devopsmaestro.git", branch: "main"

            conflicts_with "dvm", because: "both install the dvm binary"

            depends_on "go" => :build if build.head?

            def install
              if build.head?
                system "go", "build",
                       "-ldflags", "-s -w -X main.Version=HEAD -X main.Commit=#{`git rev-parse --short HEAD`.strip} -X main.BuildTime=#{Time.now.utc.iso8601}",
                       "-o", bin/"dvm",
                       "."
                generate_completions_from_executable(bin/"dvm", "completion")
              else
                bin.install "dvm"
                bash_completion.install "completions/dvm.bash" => "dvm"
                zsh_completion.install "completions/_dvm"
                fish_completion.install "completions/dvm.fish"
              end
            end

            def caveats
              <<~EOS
                To get started:
                  dvm admin init
                  dvm create app myapp --from-cwd

                Shell completions have been installed automatically for bash, zsh, and fish.
                Restart your shell or source your profile to enable them.
              EOS
            end

            test do
              assert_match "dvm", shell_output("#{bin}/dvm --help")
              assert_match version.to_s, shell_output("#{bin}/dvm version")
            end
          end
          FORMULA_EOF
          
          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" homebrew-tap/Formula/devopsmaestro.rb
          sed -i "s/DVM_DARWIN_ARM64_SHA256_PLACEHOLDER/${DVM_DARWIN_ARM64_SHA256}/g" homebrew-tap/Formula/devopsmaestro.rb
          sed -i "s/DVM_DARWIN_AMD64_SHA256_PLACEHOLDER/${DVM_DARWIN_AMD64_SHA256}/g" homebrew-tap/Formula/devopsmaestro.rb

      - name: Update nvimops formula
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          cat > homebrew-tap/Formula/nvimops.rb << 'FORMULA_EOF'
          # typed: false
          # frozen_string_literal: true

          class Nvimops < Formula
            desc "NvimOps (nvp) - DevOps-style Neovim plugin and theme manager"
            homepage "https://github.com/rmkohlman/devopsmaestro"
            version "VERSION_PLACEHOLDER"
            license "GPL-3.0"

            on_macos do
              on_arm do
                url "https://github.com/rmkohlman/devopsmaestro/releases/download/vVERSION_PLACEHOLDER/nvp_VERSION_PLACEHOLDER_darwin_arm64.tar.gz"
                sha256 "NVP_DARWIN_ARM64_SHA256_PLACEHOLDER"
              end
              on_intel do
                url "https://github.com/rmkohlman/devopsmaestro/releases/download/vVERSION_PLACEHOLDER/nvp_VERSION_PLACEHOLDER_darwin_amd64.tar.gz"
                sha256 "NVP_DARWIN_AMD64_SHA256_PLACEHOLDER"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/rmkohlman/devopsmaestro/releases/download/vVERSION_PLACEHOLDER/nvp_VERSION_PLACEHOLDER_linux_arm64.tar.gz"
                sha256 "NVP_LINUX_ARM64_SHA256_PLACEHOLDER"
              end
              on_intel do
                url "https://github.com/rmkohlman/devopsmaestro/releases/download/vVERSION_PLACEHOLDER/nvp_VERSION_PLACEHOLDER_linux_amd64.tar.gz"
                sha256 "NVP_LINUX_AMD64_SHA256_PLACEHOLDER"
              end
            end

            head "https://github.com/rmkohlman/devopsmaestro.git", branch: "main"

            depends_on "go" => :build if build.head?

            def install
              if build.head?
                system "go", "build",
                       "-ldflags", "-s -w -X main.Version=HEAD -X main.Commit=#{`git rev-parse --short HEAD`.strip} -X main.BuildTime=#{Time.now.utc.iso8601}",
                       "-o", bin/"nvp",
                       "./cmd/nvp/"
                generate_completions_from_executable(bin/"nvp", "completion")
              else
                bin.install "nvp"
                bash_completion.install "completions/nvp.bash" => "nvp"
                zsh_completion.install "completions/_nvp"
                fish_completion.install "completions/nvp.fish"
              end
            end

            def caveats
              <<~EOS
                NvimOps (nvp) - DevOps-style Neovim plugin and theme manager

                Quick Start:
                  nvp init                        # Initialize plugin store
                  nvp library list                # Browse available plugins
                  nvp library install telescope   # Install from library
                  nvp theme library list          # Browse available themes
                  nvp theme library install tokyonight-night --use
                  nvp generate                    # Generate Lua files

                Generated files: ~/.config/nvim/lua/plugins/nvp/
                Theme files:     ~/.config/nvim/lua/theme/

                Documentation: https://github.com/rmkohlman/devopsmaestro#nvimops

                Shell completions have been installed for bash, zsh, and fish.
                Restart your shell or source your profile to enable them.
              EOS
            end

            test do
              assert_match "nvp", shell_output("#{bin}/nvp --help")
              assert_match version.to_s, shell_output("#{bin}/nvp version")
            end
          end
          FORMULA_EOF
          
          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" homebrew-tap/Formula/nvimops.rb
          sed -i "s/NVP_DARWIN_ARM64_SHA256_PLACEHOLDER/${NVP_DARWIN_ARM64_SHA256}/g" homebrew-tap/Formula/nvimops.rb
          sed -i "s/NVP_DARWIN_AMD64_SHA256_PLACEHOLDER/${NVP_DARWIN_AMD64_SHA256}/g" homebrew-tap/Formula/nvimops.rb
          sed -i "s/NVP_LINUX_ARM64_SHA256_PLACEHOLDER/${NVP_LINUX_ARM64_SHA256}/g" homebrew-tap/Formula/nvimops.rb
          sed -i "s/NVP_LINUX_AMD64_SHA256_PLACEHOLDER/${NVP_LINUX_AMD64_SHA256}/g" homebrew-tap/Formula/nvimops.rb

      - name: Update terminalops formula
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          cat > homebrew-tap/Formula/terminalops.rb << 'FORMULA_EOF'
          # typed: false
          # frozen_string_literal: true

          class Terminalops < Formula
            desc "TerminalOps (dvt) - DevOps-style terminal configuration management"
            homepage "https://github.com/rmkohlman/devopsmaestro"
            version "VERSION_PLACEHOLDER"
            license "GPL-3.0"

            on_macos do
              on_arm do
                url "https://github.com/rmkohlman/devopsmaestro/releases/download/vVERSION_PLACEHOLDER/terminalops_VERSION_PLACEHOLDER_darwin_arm64.tar.gz"
                sha256 "DVT_DARWIN_ARM64_SHA256_PLACEHOLDER"
              end
              on_intel do
                url "https://github.com/rmkohlman/devopsmaestro/releases/download/vVERSION_PLACEHOLDER/terminalops_VERSION_PLACEHOLDER_darwin_amd64.tar.gz"
                sha256 "DVT_DARWIN_AMD64_SHA256_PLACEHOLDER"
              end
            end

            head "https://github.com/rmkohlman/devopsmaestro.git", branch: "main"

            depends_on "go" => :build if build.head?

            def install
              if build.head?
                system "go", "build",
                       "-ldflags", "-s -w -X main.Version=HEAD -X main.Commit=#{`git rev-parse --short HEAD`.strip} -X main.BuildTime=#{Time.now.utc.iso8601}",
                       "-o", bin/"dvt",
                       "./cmd/dvt/"
                generate_completions_from_executable(bin/"dvt", "completion")
              else
                bin.install "dvt"
                bash_completion.install "completions/dvt.bash" => "dvt"
                zsh_completion.install "completions/_dvt"
                fish_completion.install "completions/dvt.fish"
              end
            end

            def caveats
              <<~EOS
                TerminalOps (dvt) - DevOps-style terminal configuration management

                Quick Start:
                  dvt init                        # Initialize configuration directory
                  dvt prompt library list         # Browse available prompts
                  dvt prompt library install starship-default
                  dvt plugin library list         # Browse available plugins
                  dvt plugin library install zsh-autosuggestions zsh-syntax-highlighting
                  dvt profile preset install default  # Install complete profile
                  dvt profile generate default    # Generate config files

                Configuration stored in: ~/.dvt/
                Generated files written to stdout by default

                Documentation: https://github.com/rmkohlman/devopsmaestro#terminalops

                Shell completions have been installed for bash, zsh, and fish.
                Restart your shell or source your profile to enable them.
              EOS
            end

            test do
              assert_match "dvt", shell_output("#{bin}/dvt --help")
              assert_match version.to_s, shell_output("#{bin}/dvt version")
            end
          end
          FORMULA_EOF
          
          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" homebrew-tap/Formula/terminalops.rb
          sed -i "s/DVT_DARWIN_ARM64_SHA256_PLACEHOLDER/${DVT_DARWIN_ARM64_SHA256}/g" homebrew-tap/Formula/terminalops.rb
          sed -i "s/DVT_DARWIN_AMD64_SHA256_PLACEHOLDER/${DVT_DARWIN_AMD64_SHA256}/g" homebrew-tap/Formula/terminalops.rb

      - name: Commit and push formula updates
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/devopsmaestro.rb Formula/nvimops.rb Formula/terminalops.rb
          git diff --staged --quiet || git commit -m "Update formulas to v${{ steps.version.outputs.VERSION }}"
          git push
