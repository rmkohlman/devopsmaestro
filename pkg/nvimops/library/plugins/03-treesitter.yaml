apiVersion: devopsmaestro.io/v1
kind: NvimPlugin
metadata:
  name: treesitter
  description: "Syntax highlighting, indentation, and incremental selection"
  category: syntax
  tags: ["highlighting", "parsing"]
spec:
  repo: nvim-treesitter/nvim-treesitter
  build: ":TSUpdate"
  config: |
    -- Setup nvim-treesitter (new API for main branch, requires Neovim 0.11+)
    require("nvim-treesitter").setup({})

    -- Install parsers
    require("nvim-treesitter").install({
      "json", "javascript", "typescript", "tsx", "yaml", "html", "http",
      "css", "prisma", "python", "markdown", "markdown_inline", "svelte",
      "graphql", "bash", "lua", "vim", "dockerfile", "helm", "c_sharp",
      "gitignore", "csv", "query", "go", "ocaml", "php", "puppet",
      "vimdoc", "regex", "ruby", "rust", "scss", "sql", "yang", "c",
      "ssh_config", "requirements", "promql",
    })

    -- Enable highlighting via built-in Neovim API
    vim.api.nvim_create_autocmd("FileType", {
      callback = function()
        pcall(vim.treesitter.start)
      end,
    })

    -- Enable tree-sitter based indentation
    vim.api.nvim_create_autocmd("FileType", {
      callback = function()
        vim.bo.indentexpr = "v:lua.require'nvim-treesitter'.indentexpr()"
      end,
    })

    -- Incremental selection keymaps
    vim.keymap.set("n", "<C-space>", function()
      require("nvim-treesitter.incremental_selection").init_selection()
    end, { desc = "Init treesitter selection" })

    vim.keymap.set("x", "<C-space>", function()
      require("nvim-treesitter.incremental_selection").node_incremental()
    end, { desc = "Increment treesitter selection" })

    vim.keymap.set("x", "<bs>", function()
      require("nvim-treesitter.incremental_selection").node_decremental()
    end, { desc = "Decrement treesitter selection" })

    -- Use bash parser for zsh files
    vim.treesitter.language.register("bash", "zsh")
